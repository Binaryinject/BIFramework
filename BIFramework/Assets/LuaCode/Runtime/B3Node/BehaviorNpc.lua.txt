---
--- Generated by EBGAME
--- Created by wbn.
--- DateTime: 2021/09/23 03:49:23
---

---@class BehaviorNpc : UnityEngine.MonoBehaviour BehaviorNpc
---@field Base Npc 数据对象
---@field Enmity table 仇恨列表
---@field HitFlag boolean 受击判定
---@field VoiceFlag boolean 声音判定
---@field VoiceVolume number 声音音量
---@field InitModel fun(self:BehaviorNpc)
---======================== 面板变量 ========================
---@field private character Role.RoleNpc
---@field private aiCharactor AICharacter
---@field private behaviorID string
---@field rolePopup UIRolePopup
---@field private magicaAvatar MagicaCloth.MagicaAvatar
---=========================================================
local BehaviorNpc = class("BehaviorNpc", target)

--region ===================== 扩展的数据类型 =====================
--- 放自定义的结构体、枚举等

--endregion

--region ======================== 基类成员 ========================

---仇恨队列
---@private
BehaviorNpc._enmity = {}
function BehaviorNpc.Get:Enmity()
    return self._enmity
end
function BehaviorNpc.Set:Enmity(value)
    ---@private
    self._enmity = value
end

---受击flag
---@private
BehaviorNpc._hitFlag = false
function BehaviorNpc.Get:HitFlag()
    return self._hitFlag
end
function BehaviorNpc.Set:HitFlag(value)
    ---@private
    self._hitFlag = value
end

---声音flag
---@private
BehaviorNpc._voiceFlag = false
function BehaviorNpc.Get:VoiceFlag()
    return self._voiceFlag
end
function BehaviorNpc.Set:VoiceFlag(value)
    ---@private
    self._voiceFlag = value
end

---声量
---@private
BehaviorNpc._voiceVolume = false
function BehaviorNpc.Get:VoiceVolume()
    return self._voiceVolume
end
function BehaviorNpc.Set:VoiceVolume(value)
    ---@private
    self._voiceVolume = value
end

---@private
---@type Monster
BehaviorNpc._base = unmanaged
function BehaviorNpc.Get:Base()
    return self._base
end
function BehaviorNpc.Set:Base(value)
    ---@private
    self._base = value
end

---@private
BehaviorNpc._ctx = {}
---@private
BehaviorNpc._btree = {}
---@private
BehaviorNpc._env = unmanaged
---@private
---@type Vector3
BehaviorNpc._position = unmanaged

BehaviorNpc._modelPrefab = weak
BehaviorNpc.avatarId = {}

--endregion

--region ======================== 基类方法 ========================

---@param self BehaviorNpc
---@return AsyncTask void
BehaviorNpc.CreateBehavior = async(function(self)
    Debug.Log("[CreateBehavior] Npc: id = {1}, cid = {2}, gid = {3}, bid = {4}", self._base.ID, self._base.CID, self._base.GID, self.behaviorID)
    local ctx = {
        time = os.time(),
    }

    local env = {
        ctx = ctx,
        rolePopup = self.rolePopup,
        target = self._target,
        tick = 0,
        enmity = self._enmity,
        hitFlag = self._hitFlag,
        owner = self._base, --自身实体
        origin = self._position, --原始位置
        targetPosition = nil, --当前移动目标
        targetPriority = nil, --当前移动优先度
    }

    ---@private
    self._btree = await(BehaviorTree.new(self.behaviorID, env))
    self._env = env;
end)

function BehaviorNpc:Cancel()
    if self._env then
        ---@private
        self._env = nil
    end
end

---SetParams
---@param base table 本体实例
---@param position table 初始位置
function BehaviorNpc:SetParams(base, position)
    ---@private
    self._base = base
    ---@private
    self._position = position
end

function BehaviorNpc:IsRunning()
    return self._env ~= nil
end

---@param velocity Vector3
function BehaviorNpc:SetExtraForce(velocity)
    self.character.extraVelocity = velocity
end

function BehaviorNpc:DetachAllAvatarParts()
    if not self.magicaAvatar then
        return
    end
    for _, v in pairs(self.avatarId) do
        self.magicaAvatar:DetachAvatarParts(v)
    end

    if self._modelPrefab ~= weak then
        Addressable.ReleaseAssets(typeof(GameObject), self._modelPrefab)
    end
end

---@param self BehaviorNpc
BehaviorNpc.InitModel = async(function(self)
    if not self.magicaAvatar then
        return
    end
    self:DetachAllAvatarParts()
    self.avatarId = {}
    local baseClothesPlace = { 3, 4, 2, 6, 7, 8 }
    local baseClothes = { "10000", "20000", "40020", "60020", "70000", "80020" }
    local tempClothes = { 0, 0, 0, 0, 0, 0}
    local allParts = {}
    if self.Base ~= nil then
        allParts = self.Base.Config.Clothes
    else
        local cid = Configs.PieceConfig[self.transform.parent.name].Parameter[1]
        allParts = Configs.RoleNPC[tostring(cid)].Clothes
    end

    local newLocations = List(IResourceLocation)()
    for _, v in pairs(allParts) do
        local place = Configs.RoleClothes[tostring(v)].Place
        local location = CommonUtil.dressLocationData[tostring(v)]
        for _, p in pairs(place) do
            for i = 1, #baseClothesPlace do
                if baseClothesPlace[i] == p and tempClothes[i] == 0 then
                    tempClothes[i] = 1
                    if not location then
                        newLocations:Add(CommonUtil.dressLocationData[baseClothes[i]])
                    end
                    break
                end
            end
        end

        if location then
            newLocations:Add(CommonUtil.dressLocationData[tostring(v)])
        end
    end

    for i, v in pairs(tempClothes) do
        if v == 0 then
            local id = baseClothes[i]
            newLocations:Add(CommonUtil.dressLocationData[id])
        end
    end
    
    self._modelPrefab = await(Addressable.LoadAssetsAsync(typeof(GameObject), newLocations))
    for i = 0, self._modelPrefab.Count - 1 do
        local result = self._modelPrefab[i]
        local id = self.magicaAvatar:AttachAvatarParts(result)
        self.avatarId[result.name] = id
    end
end)

--endregion

--region ======================== Mono接口 ========================

-----@private
--function BehaviorNpc:Awake()
--
--end

---@private
---@param self BehaviorNpc
BehaviorNpc.Start = async(function(self)
    if GlobalSO.playMode ~= CS.GlobalSO.PlayModeEnum.ADVENTURE and GlobalSO.playMode ~= CS.GlobalSO.PlayModeEnum.BUILD_RUN then
        self.rolePopup:SetName(Configs.RoleNPC[self.transform.name].Name)
        self.rolePopup:ShowNameLayer(true)
        local gid = tonumber(self.transform.parent.parent.name)
        local params = Map.SandBoxBuilder.wfcGenerator:GetParams(gid)
        if params.Popup and params.Popup == "0" then
            self.rolePopup.popupName = false
            self.rolePopup:ShowNameLayer(false)
        end

        await(UniTask.Yield(PlayerLoopTiming.Update))
        self:InitModel()
    end
end)

---@private
function BehaviorNpc:OnDestroy()
    if GlobalSO.playMode == CS.GlobalSO.PlayModeEnum.ADVENTURE or GlobalSO.playMode == CS.GlobalSO.PlayModeEnum.BUILD_RUN then
        self:Cancel()
    end
    if self._modelPrefab ~= weak then
        Addressable.ReleaseAssets(typeof(GameObject), self._modelPrefab)
    end
end

-----@private
--function BehaviorNpc:OnDisable()
--    
--end

-----@private
--function BehaviorNpc:OnEnable()
--    
--end

---@private
function BehaviorNpc:Update()
    if not self._env then
        return
    end

    self._env.ctx.time = os.time()
    self._btree:run()
end

--endregion

return BehaviorNpc